# SMTP External Relayer

一个SMTP中继，用于将前端SMTP协议传入的的邮件通过对应的邮件中继适配器发送出去，同时保留指定的发信地址。

---

## 应用场景

自建邮箱是比较困难的：大部分云服务商都限制25端口，很多服务商也不提供rDNS解析。因此我们会考虑使用云服务商的邮件中继服务，通过云服务商帮我们代发邮件。

但是很多云服务商的邮件中继服务只允许有限数量的发信地址，对于大量发信地址的需求则无法满足。

本项目通过调用云厂商的API，动态增删发信地址，随后转发邮件，以满足大量发信地址的SMTP中继的需求。

## TL;DR

配置文件位于`config/config.yaml`，运行前需要按需配置。

在项目根目录运行`start.sh`，或者进入`src`目录然后运行`python3 main.py`即可启动。

如果启用了日志，日志会输出到`log`目录。

## 结构

此SMTP中继分为两部分。

### 前端SMTP服务器

前端会启动一个SMTP服务器，用于接收待转发的邮件。

### 后端中继适配器

适配器是针对特定服务商开发的，能够实现动态地址发信的Python模块。

待转发的邮件会传递给后端中继适配器，其负责动态增删发信地址并转发邮件给服务商，实现发信。

## 已有的中继适配器

- ~~阿里云DirectMail: 已弃用。使用一段时间后发现阿里云DirectMail对于删除发信地址的操作有每月的数量限制，无法满足大量发信地址的需求。~~

## 中继适配器开发

可以参考`aliyun_directmail`适配器进行开发。

中继适配器需要存放于`src/adapter`目录中，作为一个单独的Python模块。

中继适配器必须有一个`Adapter`类，继承`src/adapter/base.py`中的`AdapterBase`类。此`Adapter`类需要能被外部代码直接从模块中导入。

`Adapter`类需要重写`AdapterBase`的以下属性和函数：

  - `name`属性: 中继适配器名称。

  - `start()`函数: 适配器初始化函数，在程序启动时会被主模块调用。如果不需要可以不重写。

  - `send_mail(envelope: aiosmtpd.smtp.Envelope) -> str`函数: 传入邮件，中继适配器需要在此函数内完成邮件的转发。
    
    传入的参数为`aiosmtpd.smtp.Envelope`邮件对象。

    必须有返回值，返回值需要为`状态码 描述信息`格式的字符串。例如`250 Message accepted for delivery`。返回值会作为响应被发送给前端SMTP客户端。

    如果在函数内抛出异常，异常信息也会被响应给SMTP前端。

  - `stop()`函数: 适配器结束函数，用于释放资源。理想情况下程序结束时会调用此函数。
    
模块运行时的工作目录为`src`，要读取配置文件需要从`../config/config.yaml`路径读取。

项目使用`logging`模块的日志系统。
